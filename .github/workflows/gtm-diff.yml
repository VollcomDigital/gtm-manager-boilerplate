name: gtm-diff

on:
  pull_request:

jobs:
  diff:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    env:
      GTM_ACCOUNT_ID: ${{ secrets.GTM_ACCOUNT_ID }}
      GTM_CONTAINER_ID: ${{ secrets.GTM_CONTAINER_ID }}
      GTM_SERVICE_ACCOUNT_JSON_B64: ${{ secrets.GTM_SERVICE_ACCOUNT_JSON_B64 }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

    steps:
      - name: Validate required secrets
        id: precheck
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${GTM_ACCOUNT_ID}" && -n "${GTM_CONTAINER_ID}" && \
                ( -n "${GTM_SERVICE_ACCOUNT_JSON_B64}" || \
                  ( -n "${GCP_WORKLOAD_IDENTITY_PROVIDER}" && -n "${GCP_SERVICE_ACCOUNT_EMAIL}" ) ) ]]; then
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          else
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "Skipping gtm-diff: required secrets are not configured."
          fi

      - name: Checkout
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
          cache: npm

      - name: Install
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        run: npm ci

      - name: Authenticate to Google (OIDC)
        id: gcp_auth
        if: ${{ steps.precheck.outputs.enabled == 'true' && env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT_EMAIL != '' }}
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Write service account key (fallback)
        if: ${{ steps.precheck.outputs.enabled == 'true' && !(env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT_EMAIL != '') }}
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' "${GTM_SERVICE_ACCOUNT_JSON_B64}" | base64 --decode > gtm-service-account.json
          echo "Wrote gtm-service-account.json"
          echo "GTM_CREDENTIALS_PATH=${GITHUB_WORKSPACE}/gtm-service-account.json" >> "${GITHUB_ENV}"

      - name: GTM diff (workspace)
        id: gtm_diff
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        continue-on-error: true
        env:
          GTM_WORKSPACE_NAME: ${{ vars.GTM_WORKSPACE_NAME }}
          GTM_DESIRED_CONFIG_PATH: ${{ vars.GTM_DESIRED_CONFIG_PATH }}
          LOG_FORMAT: json
        shell: bash
        run: |
          set -euo pipefail
          validate_non_empty() {
            local value="$1"
            local field="$2"
            if [[ -z "${value}" || "${value}" == -* || "${value}" == *$'\n'* || "${value}" == *$'\r'* ]]; then
              echo "Invalid ${field}" >&2
              exit 2
            fi
          }

          CONFIG_PATH="${GTM_DESIRED_CONFIG_PATH:-desired.workspace.json}"
          WORKSPACE_NAME="${GTM_WORKSPACE_NAME:-Automation-Test}"

          validate_non_empty "${WORKSPACE_NAME}" "GTM_WORKSPACE_NAME"
          validate_non_empty "${CONFIG_PATH}" "GTM_DESIRED_CONFIG_PATH"

          npm run cli -- diff-workspace \
            --account-id "$GTM_ACCOUNT_ID" \
            --container-id "$GTM_CONTAINER_ID" \
            --workspace-name "$WORKSPACE_NAME" \
            --config "$CONFIG_PATH" \
            --json \
            --fail-on-drift \
            > gtm.diff.json

      - name: Upload diff artifact
        if: ${{ always() && steps.precheck.outputs.enabled == 'true' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gtm-diff
          path: gtm.diff.json

      - name: Fail PR on drift
        if: ${{ steps.precheck.outputs.enabled == 'true' && steps.gtm_diff.outcome == 'failure' }}
        run: exit 1

