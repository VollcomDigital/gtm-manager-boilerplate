name: gtm-sync

on:
  workflow_dispatch:
    inputs:
      workspace_name:
        description: "GTM workspace name (must exist or will be created)"
        required: true
        default: "Automation-Test"
        type: string
      desired_config_path:
        description: "Path to desired workspace JSON config in repo"
        required: true
        default: "desired.workspace.json"
        type: string
      delete_missing:
        description: "Delete entities not present in desired config"
        required: true
        default: false
        type: boolean
      publish:
        description: "Create + publish a container version after sync"
        required: true
        default: false
        type: boolean
      version_name:
        description: "Container version name (only if publish=true)"
        required: false
        default: "IaC Release"
        type: string
      version_notes:
        description: "Container version notes (only if publish=true)"
        required: false
        default: "Automated publish from GitHub Actions"
        type: string
      dry_run:
        description: "Do not perform mutations (prints intended actions)"
        required: true
        default: true
        type: boolean
  push:
    branches:
      - main

jobs:
  sync_dispatch:
    runs-on: ubuntu-latest

    if: ${{ github.event_name == 'workflow_dispatch' }}

    permissions:
      contents: read
      id-token: write

    env:
      GTM_ACCOUNT_ID: ${{ secrets.GTM_ACCOUNT_ID }}
      GTM_CONTAINER_ID: ${{ secrets.GTM_CONTAINER_ID }}
      GTM_SERVICE_ACCOUNT_JSON_B64: ${{ secrets.GTM_SERVICE_ACCOUNT_JSON_B64 }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

    steps:
      - name: Validate required secrets
        id: precheck
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${GTM_ACCOUNT_ID}" && -n "${GTM_CONTAINER_ID}" && \
                ( -n "${GTM_SERVICE_ACCOUNT_JSON_B64}" || \
                  ( -n "${GCP_WORKLOAD_IDENTITY_PROVIDER}" && -n "${GCP_SERVICE_ACCOUNT_EMAIL}" ) ) ]]; then
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          else
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "Skipping gtm-sync dispatch: required secrets are not configured."
          fi

      - name: Checkout
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Install
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        run: npm ci

      - name: Authenticate to Google (OIDC)
        id: gcp_auth
        if: ${{ steps.precheck.outputs.enabled == 'true' && env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT_EMAIL != '' }}
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Write service account key (fallback)
        if: ${{ steps.precheck.outputs.enabled == 'true' && !(env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT_EMAIL != '') }}
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' "${GTM_SERVICE_ACCOUNT_JSON_B64}" | base64 --decode > gtm-service-account.json
          echo "Wrote gtm-service-account.json"
          echo "GTM_CREDENTIALS_PATH=${GITHUB_WORKSPACE}/gtm-service-account.json" >> "${GITHUB_ENV}"

      - name: Sync workspace
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        env:
          WORKSPACE_NAME_INPUT: ${{ inputs.workspace_name }}
          CONFIG_PATH_INPUT: ${{ inputs.desired_config_path }}
          DELETE_MISSING_INPUT: ${{ inputs.delete_missing }}
          DRY_RUN_INPUT: ${{ inputs.dry_run }}
          LOG_FORMAT: json
        shell: bash
        run: |
          set -euo pipefail
          validate_non_empty() {
            local value="$1"
            local field="$2"
            if [[ -z "${value}" || "${value}" == -* || "${value}" == *$'\n'* || "${value}" == *$'\r'* ]]; then
              echo "Invalid ${field}" >&2
              exit 2
            fi
          }

          parse_bool() {
            local value="$1"
            case "${value}" in
              true|false) printf '%s' "${value}" ;;
              *)
                echo "Invalid boolean input: ${value}" >&2
                exit 2
                ;;
            esac
          }

          WORKSPACE_NAME="${WORKSPACE_NAME_INPUT}"
          CONFIG_PATH="${CONFIG_PATH_INPUT}"
          DELETE_MISSING="$(parse_bool "${DELETE_MISSING_INPUT}")"
          DRY_RUN="$(parse_bool "${DRY_RUN_INPUT}")"

          validate_non_empty "${WORKSPACE_NAME}" "workspace_name"
          validate_non_empty "${CONFIG_PATH}" "desired_config_path"

          EXTRA_ARGS=()
          if [[ "${DELETE_MISSING}" == "true" ]]; then
            EXTRA_ARGS+=(--delete-missing --confirm)
          fi
          if [[ "${DRY_RUN}" == "true" ]]; then
            EXTRA_ARGS+=(--dry-run)
          fi

          npm run cli -- sync-workspace \
            --account-id "$GTM_ACCOUNT_ID" \
            --container-id "$GTM_CONTAINER_ID" \
            --workspace-name "$WORKSPACE_NAME" \
            --config "$CONFIG_PATH" \
            --json \
            "${EXTRA_ARGS[@]}" \
            > gtm.sync.json

      - name: Create container version (optional)
        if: ${{ steps.precheck.outputs.enabled == 'true' && inputs.publish == true && inputs.dry_run == false }}
        env:
          WORKSPACE_NAME_INPUT: ${{ inputs.workspace_name }}
          VERSION_NAME_INPUT: ${{ inputs.version_name }}
          VERSION_NOTES_INPUT: ${{ inputs.version_notes }}
          LOG_FORMAT: json
        shell: bash
        run: |
          set -euo pipefail
          validate_non_empty() {
            local value="$1"
            local field="$2"
            if [[ -z "${value}" || "${value}" == -* || "${value}" == *$'\n'* || "${value}" == *$'\r'* ]]; then
              echo "Invalid ${field}" >&2
              exit 2
            fi
          }

          WORKSPACE_NAME="${WORKSPACE_NAME_INPUT}"
          VERSION_NAME="${VERSION_NAME_INPUT}"
          VERSION_NOTES="${VERSION_NOTES_INPUT}"

          validate_non_empty "${WORKSPACE_NAME}" "workspace_name"
          validate_non_empty "${VERSION_NAME}" "version_name"
          validate_non_empty "${VERSION_NOTES}" "version_notes"

          npm run cli -- create-version \
            --account-id "$GTM_ACCOUNT_ID" \
            --container-id "$GTM_CONTAINER_ID" \
            --workspace-name "$WORKSPACE_NAME" \
            --version-name "$VERSION_NAME" \
            --notes "$VERSION_NOTES" \
            --json \
            > gtm.create-version.json

          node -e 'const fs=require("node:fs"); const j=JSON.parse(fs.readFileSync("gtm.create-version.json","utf8")); const p=j?.containerVersion?.path; if(!p) { console.error("Missing containerVersion.path"); process.exit(2); } fs.writeFileSync("gtm.version-path.txt", p);'

      - name: Publish container version (optional)
        if: ${{ steps.precheck.outputs.enabled == 'true' && inputs.publish == true && inputs.dry_run == false }}
        env:
          LOG_FORMAT: json
        shell: bash
        run: |
          set -euo pipefail
          VERSION_PATH="$(<gtm.version-path.txt)"
          npm run cli -- publish-version --version-path "$VERSION_PATH" --confirm --json > gtm.publish-version.json

      - name: Write job summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require("node:fs");
          const summaryPath = process.env.GITHUB_STEP_SUMMARY;
          const readJson = (p) => {
            try { return JSON.parse(fs.readFileSync(p, "utf8")); } catch { return null; }
          };

          const sync = readJson("gtm.sync.json");
          const created = (x) => (x?.created?.length ?? 0);
          const updated = (x) => (x?.updated?.length ?? 0);
          const deleted = (x) => (x?.deleted?.length ?? 0);
          const skipped = (x) => (x?.skipped?.length ?? 0);

          let md = "## GTM Sync\\n\\n";
          if (sync) {
            md += `Workspace: \`${sync.workspacePath ?? "?"}\`\\n\\n`;
            md += "| Entity | Created | Updated | Deleted | Skipped |\\n";
            md += "|---|---:|---:|---:|---:|\\n";
            md += `| Environments | ${created(sync.environments)} | ${updated(sync.environments)} | ${deleted(sync.environments)} | ${skipped(sync.environments)} |\\n`;
            md += `| Templates | ${created(sync.templates)} | ${updated(sync.templates)} | ${deleted(sync.templates)} | ${skipped(sync.templates)} |\\n`;
            md += `| Variables | ${created(sync.variables)} | ${updated(sync.variables)} | ${deleted(sync.variables)} | ${skipped(sync.variables)} |\\n`;
            md += `| Built-in Variables | ${created(sync.builtInVariables)} | ${updated(sync.builtInVariables)} | ${deleted(sync.builtInVariables)} | ${skipped(sync.builtInVariables)} |\\n`;
            md += `| Clients | ${created(sync.clients)} | ${updated(sync.clients)} | ${deleted(sync.clients)} | ${skipped(sync.clients)} |\\n`;
            md += `| Transformations | ${created(sync.transformations)} | ${updated(sync.transformations)} | ${deleted(sync.transformations)} | ${skipped(sync.transformations)} |\\n`;
            md += `| Triggers | ${created(sync.triggers)} | ${updated(sync.triggers)} | ${deleted(sync.triggers)} | ${skipped(sync.triggers)} |\\n`;
            md += `| Zones | ${created(sync.zones)} | ${updated(sync.zones)} | ${deleted(sync.zones)} | ${skipped(sync.zones)} |\\n`;
            md += `| Folders | ${created(sync.folders)} | ${updated(sync.folders)} | ${deleted(sync.folders)} | ${skipped(sync.folders)} |\\n`;
            md += `| Tags | ${created(sync.tags)} | ${updated(sync.tags)} | ${deleted(sync.tags)} | ${skipped(sync.tags)} |\\n`;
            md += "\\n";
          } else {
            md += "_No sync output found._\\n\\n";
          }

          const publish = readJson("gtm.publish-version.json");
          if (publish?.containerVersion?.path) {
            md += "## Published Version\\n\\n";
            md += `Path: \`${publish.containerVersion.path}\`\\n\\n`;
            md += `Name: \`${publish.containerVersion.name ?? "?"}\`\\n\\n`;
            md += `VersionId: \`${publish.containerVersion.containerVersionId ?? "?"}\`\\n\\n`;
            md += `Timestamp: \`${new Date().toISOString()}\`\\n\\n`;
          }

          fs.appendFileSync(summaryPath, md);
          NODE

      - name: Upload artifacts
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gtm-sync-artifacts
          path: |
            gtm.sync.json
            gtm.create-version.json
            gtm.publish-version.json
            gtm.version-path.txt

  sync_push:
    runs-on: ubuntu-latest

    # Opt-in required for automatic sync on main pushes.
    if: >-
      ${{
        github.event_name == 'push' &&
        vars.GTM_SYNC_ON_PUSH == 'true' &&
        vars.GTM_WORKSPACE_NAME != '' &&
        vars.GTM_DESIRED_CONFIG_PATH != ''
      }}

    permissions:
      contents: read
      id-token: write

    env:
      GTM_ACCOUNT_ID: ${{ secrets.GTM_ACCOUNT_ID }}
      GTM_CONTAINER_ID: ${{ secrets.GTM_CONTAINER_ID }}
      GTM_SERVICE_ACCOUNT_JSON_B64: ${{ secrets.GTM_SERVICE_ACCOUNT_JSON_B64 }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

    steps:
      - name: Validate required secrets
        id: precheck
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${GTM_ACCOUNT_ID}" && -n "${GTM_CONTAINER_ID}" && \
                ( -n "${GTM_SERVICE_ACCOUNT_JSON_B64}" || \
                  ( -n "${GCP_WORKLOAD_IDENTITY_PROVIDER}" && -n "${GCP_SERVICE_ACCOUNT_EMAIL}" ) ) ]]; then
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          else
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "Skipping gtm-sync push: required secrets are not configured."
          fi

      - name: Checkout
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Install
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        run: npm ci

      - name: Authenticate to Google (OIDC)
        id: gcp_auth
        if: ${{ steps.precheck.outputs.enabled == 'true' && env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT_EMAIL != '' }}
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Write service account key (fallback)
        if: ${{ steps.precheck.outputs.enabled == 'true' && !(env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT_EMAIL != '') }}
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' "${GTM_SERVICE_ACCOUNT_JSON_B64}" | base64 --decode > gtm-service-account.json
          echo "Wrote gtm-service-account.json"
          echo "GTM_CREDENTIALS_PATH=${GITHUB_WORKSPACE}/gtm-service-account.json" >> "${GITHUB_ENV}"

      - name: Sync workspace (push)
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        env:
          GTM_WORKSPACE_NAME: ${{ vars.GTM_WORKSPACE_NAME }}
          GTM_DESIRED_CONFIG_PATH: ${{ vars.GTM_DESIRED_CONFIG_PATH }}
          LOG_FORMAT: json
        shell: bash
        run: |
          set -euo pipefail
          npm run cli -- sync-workspace \
            --account-id "$GTM_ACCOUNT_ID" \
            --container-id "$GTM_CONTAINER_ID" \
            --workspace-name "$GTM_WORKSPACE_NAME" \
            --config "$GTM_DESIRED_CONFIG_PATH" \
            --json \
            > gtm.sync.json

      - name: Upload artifacts (push)
        if: ${{ steps.precheck.outputs.enabled == 'true' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gtm-sync-push-artifacts
          path: gtm.sync.json

      - name: Write job summary (push)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require("node:fs");
          const summaryPath = process.env.GITHUB_STEP_SUMMARY;
          const readJson = (p) => {
            try { return JSON.parse(fs.readFileSync(p, "utf8")); } catch { return null; }
          };
          const sync = readJson("gtm.sync.json");
          if (!sync) {
            fs.appendFileSync(summaryPath, "## GTM Sync\\n\\n_No sync output found._\\n");
            process.exit(0);
          }
          const created = (x) => (x?.created?.length ?? 0);
          const updated = (x) => (x?.updated?.length ?? 0);
          const deleted = (x) => (x?.deleted?.length ?? 0);
          const skipped = (x) => (x?.skipped?.length ?? 0);
          let md = "## GTM Sync (push)\\n\\n";
          md += `Workspace: \`${sync.workspacePath ?? "?"}\`\\n\\n`;
          md += "| Entity | Created | Updated | Deleted | Skipped |\\n";
          md += "|---|---:|---:|---:|---:|\\n";
          md += `| Environments | ${created(sync.environments)} | ${updated(sync.environments)} | ${deleted(sync.environments)} | ${skipped(sync.environments)} |\\n`;
          md += `| Templates | ${created(sync.templates)} | ${updated(sync.templates)} | ${deleted(sync.templates)} | ${skipped(sync.templates)} |\\n`;
          md += `| Variables | ${created(sync.variables)} | ${updated(sync.variables)} | ${deleted(sync.variables)} | ${skipped(sync.variables)} |\\n`;
          md += `| Built-in Variables | ${created(sync.builtInVariables)} | ${updated(sync.builtInVariables)} | ${deleted(sync.builtInVariables)} | ${skipped(sync.builtInVariables)} |\\n`;
          md += `| Clients | ${created(sync.clients)} | ${updated(sync.clients)} | ${deleted(sync.clients)} | ${skipped(sync.clients)} |\\n`;
          md += `| Transformations | ${created(sync.transformations)} | ${updated(sync.transformations)} | ${deleted(sync.transformations)} | ${skipped(sync.transformations)} |\\n`;
          md += `| Triggers | ${created(sync.triggers)} | ${updated(sync.triggers)} | ${deleted(sync.triggers)} | ${skipped(sync.triggers)} |\\n`;
          md += `| Zones | ${created(sync.zones)} | ${updated(sync.zones)} | ${deleted(sync.zones)} | ${skipped(sync.zones)} |\\n`;
          md += `| Folders | ${created(sync.folders)} | ${updated(sync.folders)} | ${deleted(sync.folders)} | ${skipped(sync.folders)} |\\n`;
          md += `| Tags | ${created(sync.tags)} | ${updated(sync.tags)} | ${deleted(sync.tags)} | ${skipped(sync.tags)} |\\n`;
          md += `\\nTimestamp: \`${new Date().toISOString()}\`\\n`;
          fs.appendFileSync(summaryPath, md);
          NODE

